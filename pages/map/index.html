<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <title>canvasとイベント処理による描画</title>			
        <link rel="stylesheet" href="./css3/main.css" media="all">
		<!--leaflet-->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.3.0/dist/leaflet.js"></script>
		<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
		<script src ="https://data.earth.jaxa.jp/api/javascript/v1.2.2/jaxa.earth.umd.js"></script>	
		<script src="https://unpkg.com/georaster"></script>
		<script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
		<!-- leaflet plugin -->
			<link rel="stylesheet" href="./css3/leaflet-search.min.css">
			<script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script>
			<!--座標取得-->
			<script src="./Js/L.Control.Locate.min.js"></script>
			<script src="./Js/L.Control.Locate.min.js.map"></script>
		<!-- leaflet プラグインCSS-->
			<link rel="stylesheet" href="https://unpkg.com/leaflet-switch-basemap@1.0.6/src/L.switchBasemap.css" crossorigin=""/>
			<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
			<link rel="stylesheet" href="./css3/L.Control.Locate.min.css" />
			<link rel="stylesheet" href="./Js/L.Control.Locate.min.js.map"/>
		<!-- Plugin Icon.Pulse -->
			<link rel="stylesheet" href="./css3/L.Icon.Pulse.css" >
			<script src="./Js/L.Icon.Pulse.js" ></script>
		<!-- Plugin slider -->
			<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
			<link rel="stylesheet" href="css3/leaflet-slider.css" />
			<script src="js/leaflet-slider.js"></script>
        <style>
			*{
				margin:0;
				padding:0;
			}						
			
			#rain_fall {
				height: 600px;
				width: 600px;
				display: flex;
				justify-content: center;
			}
			#map_canvas1 {background-color:orange};
			input {
				margin: 10px;
				padding: 5px;
			}
			#mapcontainer {
				border: solid 5px orange;
				height: 600px;
				width: 100%;
			}
            #mycanvas { border: 1px solid;  }
			
			datalist {
				display: flex;
				flex-direction: column;
				justify-content: space-between;
				writing-mode: vertical-lr;
				width: 200px;
			}				
			option {padding: 0;}				
			input[type="range"] {width: 200px;margin: 0;}
			
			/* ずかんマーカー用のスタイル */
			.custom-zukan-marker {
				background: transparent;
			}
			
			.zukan-legend {
				font-family: sans-serif;
			}
        </style>
                  
    </head>
    
    <body>
		<div class="overlay" id="overlay">
			<div class="title-block">
				<h1>新発田ずかん</h1>
				<div class="subtitle">しばたの自然を楽しむWebアプリ</div>
			<br></div>			
		</div>
		
		<nav class="side-menu" id="sideMenu">
            <div class="menu-title"><i class="fa-solid fa-user"></i> <span id="userNameDisplay">ユーザー名</span></div>
            <a href="https://shibatazukan.github.io/pages/home/index.html"><i class="fa-solid fa-house"></i> ホーム</a>
            <a href="https://shibatazukan.github.io/pages/zukan/list.html"><i class="fa-solid fa-scroll"></i> ずかん</a>
            <a href="https://shibatazukan.github.io/pages/camera/index.html"><i class="fa-solid fa-camera"></i> カメラ</a>
            <a href="https://shibatazukan.github.io/pages/map/folder/index.html"><i class="fa-solid fa-map"></i> マップ</a>
            <div class="menu-divider"></div>
            <button class="menu-item" id="shareData">
                <i class="fa-solid fa-share"></i> データを共有/ファイルに保存
            </button>
            <button class="menu-item" id="loadData">
                <i class="fa-solid fa-upload"></i> データをロード
            </button>
            <input type="file" id="fileInput" class="file-input" accept=".json">
            <div class="menu-divider"></div>
            <a href="settings.html"><i class="fa-solid fa-gear"></i> せってい</a>
            <a href="../help/index.html"><i class="fa-solid fa-circle-question"></i> ヘルプ</a>
        </nav>
		        		        		
        <p>イベント処理で描画を実行するプログラム例</p>
	
		<div class="txt-margin">
			<p>緯度：<span id="latitude">???</span><span>度</span></p>
			<p>経度：<span id="longitude">???</span><span>度</span></p>
			<p>高度：<span id="altitude">???</span><span>度</span></p>		            
		</div>			
		
		<label for="observe">時系列を選択</label><br/>
		
		<div id="a">
			<input type="range" id="observe" min="2020" max="2025" step="1" list="years"/>好きな年度を選択
			<datalist id="years">
				<option value="2020" label="2020"></option>
				<option value="2021" label="2021"></option>
				<option value="2022" label="2022"></option>
				<option value="2023" label="2023"></option>
				<option value="2024" label="2024"></option>
				<option value="2025" label="2025"></option>
			</datalist>
		</div>
		
        <p>マイずかんの生物をマップに表示</p>

        <button id="chage_color" style="width: 100px; height: 100px; border: solid" onclick="alert('描画ボタン')">clickして描画</button>

		<button type="button" onclick="alert('クリックされました')">ここをクリック</button>

		<div id="mapcontainer"></div>			 
		<p>activemap直下</p>
       
        <div class="menu-toggle" id="menuToggle">
            <i class="fa-solid fa-bars"></i>
        </div>
						
       <main>
			<div id="mapid"></div>
			<div id="map-container"></div>
			<p id="temperature"></p>
			<p>アカウントにログインしてください:<span id="map-container">???</span><span>確認用</span></p>
		</main>       
			                              				 	        
        <script>
			'use strict';
			{
				//スライダ要素を取得				
				let observe = document.getElementById('observe');
				let selyear = 2021;									
				console.log('observe', observe);
				
				// スライダの選択が変更されたときのイベントリスナーを登録
				observe.addEventListener('change', () => {
					selyear = observe.value;
					console.log('西暦年:', selyear);
				});
				
				//現在の温度を表示
				{
					const apiUrl = 'https://api.open-meteo.com/v1/forecast?latitude=37.56&longitude=139.19&hourly=temperature_2m&timezone=Asia/Tokyo';							
					fetch(apiUrl)
					.then(response => {
						if (!response.ok) {
							throw new Error(`HTTP error! status: ${response.status}`);
						}
						return response.json();
					})					              					              					              					              					             								 
					.then(data => {
						if (data && data.hourly && data.hourly.temperature_2m && data.hourly.temperature_2m.length > 0) {
							const latestTemperature = data.hourly.temperature_2m[0];										  
							const temperatureElement = document.getElementById('temperature');
							temperatureElement.textContent = `現在の気温は${latestTemperature}℃です`;										  
						} else {
							console.warn('APIレスポンスに予期せぬデータ形式、または気温データが見つかりませんでした。');
							const temperatureElement = document.getElementById('temperature');
							temperatureElement.textContent = '気温データを取得できませんでした。';
						}
					})								
					.catch(error => {
						console.error('データ取得に失敗しました:', error);
						const temperatureElement = document.getElementById('temperature');
						temperatureElement.textContent = '気温データの取得中にエラーが発生しました。詳細はコンソールを確認してください。';
					});
				}
																			
				//現在地を取得（GPSによる位置情報を取得出来た場合は上書き交信）
				{
					navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
					
					function successCallback(position) {   
						var latitude = position.coords.latitude;
						var longitude = position.coords.longitude;
						var altitude = position.coords.altitude;
						alert("位置情報の取得に成功しました。");
						document.getElementById("latitude").innerHTML = latitude;
						document.getElementById("longitude").innerHTML = longitude;
						document.getElementById("altitude").innerHTML = altitude;
						
						console.log('経度:', latitude);
						console.log('緯度:', longitude);
					}																					
					
					function errorCallback(error) {
						alert("[GPS]位置情報が取得できませんでした");
					}														
				}

				// ========================================
				// ずかんデータをマップに表示する機能
				// ========================================
				
				function loadZukanMarkersToMap(map) {
					const zukanData = JSON.parse(localStorage.getItem('myZukan') || '[]');
					
					if (zukanData.length === 0) {
						console.log('マイずかんにデータがありません');
						return;
					}

					// カテゴリごとに色分け（昆虫、鳥類、植物のみ）
					const categoryColors = {
						'昆虫': '#f59e0b',
						'鳥類': '#3b82f6',
						'植物': '#22c55e'
					};

					const markers = [];

					zukanData.forEach((entry, index) => {
						if (!entry.location || !entry.location.latitude || !entry.location.longitude) {
							console.log(`${entry.name} には位置情報がありません`);
							return;
						}

						const category = entry.category;
						
						// 昆虫、鳥類、植物のみを表示
						if (!categoryColors[category]) {
							console.log(`${entry.name} はカテゴリ「${category}」のため表示されません`);
							return;
						}

						const { latitude, longitude, address } = entry.location;
						const color = categoryColors[category];

						// カスタムアイコンを作成
						const customIcon = L.divIcon({
							className: 'custom-zukan-marker',
							html: `
								<div style="
									width: 30px;
									height: 30px;
									background-color: ${color};
									border: 3px solid white;
									border-radius: 50%;
									box-shadow: 0 2px 5px rgba(0,0,0,0.3);
									display: flex;
									align-items: center;
									justify-content: center;
									font-weight: bold;
									color: white;
									font-size: 12px;
								">
									${index + 1}
								</div>
							`,
							iconSize: [30, 30],
							iconAnchor: [15, 15],
							popupAnchor: [0, -15]
						});

						const marker = L.marker([latitude, longitude], {
							icon: customIcon
						});

						const confidencePercent = (entry.confidence * 100).toFixed(1);
						const matchInfo = entry.matchCount && entry.totalSamples 
							? `<p><strong>一致枚数:</strong> ${entry.matchCount}/${entry.totalSamples}枚</p>`
							: '';
						
						const popupContent = `
							<div style="min-width: 200px;">
								<h3 style="margin: 0 0 10px 0; color: ${color}; border-bottom: 2px solid ${color}; padding-bottom: 5px;">
									${entry.name}
								</h3>
								<p><strong>種類:</strong> ${category}</p>
								<p><strong>説明:</strong> ${entry.description}</p>
								<p><strong>信頼度:</strong> ${confidencePercent}%</p>
								${matchInfo}
								<p><strong>登録日:</strong> ${new Date(entry.date).toLocaleString('ja-JP')}</p>
								<p><strong>場所:</strong> ${address || '住所不明'}</p>
								<p style="font-size: 0.9em; color: #666;">
									緯度: ${latitude.toFixed(6)}<br>
									経度: ${longitude.toFixed(6)}
								</p>
							</div>
						`;

						marker.bindPopup(popupContent);
						marker.addTo(map);
						markers.push(marker);
					});

					console.log(`${markers.length}個のマーカーを表示しました`);

					if (markers.length > 0) {
						const group = L.featureGroup(markers);
						map.fitBounds(group.getBounds().pad(0.1));
					}

					return markers;
				}

				// 凡例を追加
				function addZukanLegend(map) {
					const legend = L.control({ position: 'bottomright' });

					legend.onAdd = function() {
						const div = L.DomUtil.create('div', 'zukan-legend');
						div.innerHTML = `
							<div style="
								background: white;
								padding: 10px;
								border-radius: 5px;
								box-shadow: 0 2px 5px rgba(0,0,0,0.3);
								font-size: 12px;
							">
								<h4 style="margin: 0 0 8px 0;">マイずかん凡例</h4>
								<div><span style="color: #22c55e;">●</span> 植物</div>
								<div><span style="color: #f59e0b;">●</span> 昆虫</div>
								<div><span style="color: #3b82f6;">●</span> 鳥類</div>
							</div>
						`;
						return div;
					};

					legend.addTo(map);
				}

				//Leaflet_Main
				console.log('Leaflet初期化開始');
														
				(async function() {
					var map = L.map('mapcontainer', { renderer: L.canvas() });

					map.on('overlayadd', function() {
						alert('衛星画像をオーバラップします。');
					});

					map.setView([37.9473, 139.32825], 15);
					
					var gsiattr = "<a href='http://portal.cyberjapan.jp/help/termsofuse.html' target='_blank'>地理院タイル</a>";
					
					var gsi = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: gsiattr });
					var gsipale = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', { attribution: gsiattr });
					var osm = L.tileLayer('http://tile.openstreetmap.jp/{z}/{x}/{y}.png', { attribution: "<a href='http://osm.org/copyright' target='_blank'>OpenStreetMap</a> contributors" });								

					var gsirelief = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', { opacity: 0.7, maxNativeZoom: 15, attribution: gsiattr });
					var gsirehillshademap = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png', { opacity: 0.5, maxNativeZoom: 16, attribution: gsiattr });
					var gsiaa = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 1, maxNativeZoom: 15, attribution: gsiattr });

					var gsibb = je.leaflet.createLayer({
						opacity: "0.5",
						L,								
						collection: "https://s3.ap-northeast-1.wasabisys.com/je-pds/cog/v1/JAXA.EORC_ALOS.PRISM_AW3D30.v3.2_global/collection.json",
						band: "DSM",
						date: new Date(Date.UTC(selyear, 6 - 1)),
						colorMap: {
							min: 0,
							max: 6000,
							colors: "jet",
						} 												
					});
					
					var harotirekun = L.tileLayer('https://www.mhlw.go.jp/content/11600000/001447552.png', { opacity: 0.7, maxNativeZoom: 15, attribution: gsiattr });
					
					var nas = je.leaflet.createLayer({	
						opacity: "0.5", 
						L,								
						collection: "https://s3.ap-northeast-1.wasabisys.com/je-pds/cog/v1/JAXA.EORC_ALOS-2.PALSAR-2_FNF.v2.1.0_global_yearly/collection.json",
						band: "FNF",
						bbox: [123, 24, 150, 50],														
						colorMap: {														
							min: 0.3,
							max: 6000,
							colors: "gray",														
						}
					});
					
					var jax = je.leaflet.createLayer({
						opacity: "0.5",
						L,								
						collection: "https://s3.ap-northeast-1.wasabisys.com/je-pds/cog/v1/JAXA.JASMES_GCOM-C.SGLI_standard.L2-NDVI.daytime.v3_japan_8-day/collection.json",
						band: "NDVI_AVE",																	
						colorMap: {														 		
							min: 0, 
							max: 1,
							colors: "ndvi",																															
						}
					});

					var baseMaps = {
						"地理院地図": gsi,
						"淡色地図": gsipale,
						"openst:Normal": osm,
						"色別標高図": gsirelief,
						"陰影起伏図": gsirehillshademap,
						"openst:{s}入り": gsiaa,
					};
					
					var earthMaps = {
						"[衛星画像]:DSM": gsibb,
						"ハロトレ": harotirekun,
						"[衛星画像];FNF": nas,
						"[衛星画像]:NDVI": jax
					};

					console.log('マーカー追加');
													
					L.marker([37.9473, 139.32825]).addTo(map)
						.bindPopup('新発田市役所[ヨリネスしばた]')
						.openPopup();
					
					L.control.layers(baseMaps, earthMaps).addTo(map);
					L.control.scale({
						position: "topleft",
						title: "Reset view",
						latlng: L.latLng([37.9473, 139.32825]),
						zoom: 15,
					}).addTo(map);
					
					L.control.slider(function(value) {
						map.setView(map.getCenter(), value);
					}, {
						max: 16, 
						min: 13, 
						value: 15, 
						step: 1, 
						size: '250px', 
						orientation: 'vertical', 
						id: 'slider', 
						logo: '<i class="fas fa-sliders-h"></i>'
					}).addTo(map);
					
					gsi.addTo(map);
					
					// ========================================
					// ずかんマーカーを表示
					// ========================================
					setTimeout(() => {
						console.log('ずかんマーカー読み込み開始');
						loadZukanMarkersToMap(map);
						addZukanLegend(map);
					}, 1000);
					
				})();	
													
				window.addEventListener('load', function() {
					console.log('ページ読み込み完了');
				});
			}														
		</script>
		
		<div class="notification" id="notification"></div> 				
		<div class="buttons">
			<a href="https://shibatazukan.github.io/pages/zukan/list.html" class="button-link"><i class="fa-solid fa-scroll"></i>ずかんを開く</a>
			<a href="https://shibatazukan.github.io/pages/camera/index.html" class="button-link"><i class="fa-solid fa-camera"></i>カメラを開く</a>
			<a href="https://shibatazukan.github.io/pages/camera/index.html" class="button-link"><i class="fa-solid fa-map"></i>マップを開く</a>
			<a href="https://shibatazukan.github.io/pages/MobileNet/index.html" class="button-link"><i class="fa-solid fa-robot"></i>かんたん！AI体験</a>
		</div>            
	</body>
</html>
